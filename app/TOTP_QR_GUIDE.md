# Руководство по использованию TOTP и QR-кодов

## Общая архитектура

### Компоненты системы:
1. **TOTP Service** (`totp_service.dart`) - Генерация и проверка TOTP кодов
2. **Auth Service** (`auth_service.dart`) - Управление аутентификацией пользователей
3. **Database Service** (`database_service.dart`) - Сохранение пользователей и их TOTP секретов
4. **User Model** (`user.dart`) - Модель пользователя с поддержкой TOTP

### Как это работает:

#### 1. Регистрация пользователя с TOTP
```dart
final user = await authService.registerUser(
  'username',
  'password',
  Role.user,
  generateTotp: true,  // Генерировать TOTP секрет
);
```

#### 2. Генерация QR-кода
```dart
final totpService = TotpService();
final secret = user.totpSecret;
final otpUri = 'otpauth://totp/$username?secret=$secret&issuer=CryptoApp';
```

#### 3. Проверка TOTP кода
```dart
final isValid = totpService.verifyTotpCode(
  user.totpSecret!,
  enteredCode,
  username: user.username,  // Для отладки
);
```

## Уникальность TOTP секретов

### Проблема, которая была решена:
- **Раньше:** Все пользователи получали одинаковый TOTP секрет
- **Сейчас:** Каждый пользователь получает уникальный секрет при регистрации

### Как это обеспечивается:
1. **Генерация секрета:** `generateTotpSecret()` использует криптографически безопасный генератор случайных чисел
2. **Сохранение секрета:** Каждый секрет сохраняется в базе данных вместе с пользователем
3. **Проверка кодов:** При аутентификации используется именно секрет конкретного пользователя

### Пример проверки уникальности:
```dart
// Регистрируем двух пользователей
final user1 = await authService.registerUser('user1', 'pass1', Role.user, generateTotp: true);
final user2 = await authService.registerUser('user2', 'pass2', Role.user, generateTotp: true);

// Проверяем, что секреты разные
print(user1.totpSecret != user2.totpSecret);  // true
```

## Отладка и логирование

### Что выводится в консоль:
1. **Имя пользователя** - для идентификации, для какого пользователя идет проверка
2. **TOTP секрет** - отладочная информация для проверки правильности
3. **Введенный код** - код, который ввел пользователь
4. **Сгенерированные коды** - текущий, предыдущий и следующий коды
5. **Результаты проверки** - какие коды прошли проверку

### Пример вывода:
```
TOTP Debug для пользователя: user1:
  Секрет: JBSWY3DPEHPK3PXP
  Введенный код: 123456
  Текущий код: 654321
  Предыдущий код: 987654
  Следующий код: 456789
  Текущий код верен: false
  Предыдущий код верен: true
  Следующий код верен: false
```

## Тестирование

### Доступные тесты:
1. **`debug_totp.dart`** - Отладка TOTP системы
2. **`test_unique_totp.dart`** - Проверка уникальности секретов

### Как запустить тесты:
```bash
# Запуск отладки TOTP
dart debug_totp.dart

# Запуск теста уникальности
dart test_unique_totp.dart
```

## Безопасность

### Защита от повторного использования кодов:
1. **Временное окно:** Коды действительны 30 секунд
2. **Двойная проверка:** Проверяются текущий, предыдущий и следующий коды
3. **Криптографическая стойкость:** Используются безопасные алгоритмы

### Защита от подбора кодов:
1. **Ограничение по времени:** Коды быстро устаревают
2. **Хеширование паролей:** Пароли хранятся в виде хешей
3. **Уникальные секреты:** Каждый пользователь имеет свой секрет

## Интеграция с мобильными приложениями

### Для настройки TOTP на мобильном устройстве:
1. **Сканируйте QR-код** с помощью приложения аутентификации
2. **Рекомендуемые приложения:**
   - Google Authenticator
   - Microsoft Authenticator
   - Authy
   - FreeOTP

### Формат QR-кода:
```
otpauth://totp/username?secret=JBSWY3DPEHPK3PXP&issuer=CryptoApp
```

## Устранение неполадок

### Проблема: "Неверные данные аутентификации"
1. **Проверьте время** на устройстве - должно быть синхронизировано
2. **Убедитесь, что QR-код** отсканирован правильно
3. **Проверьте, что используете правильный** секрет в приложении аутентификации
4. **Посмотрите логи** в консоли для отладки

### Проблема: Одинаковые коды для разных пользователей
1. **Запустите тест** `test_unique_totp.dart`
2. **Проверьте логи** регистрации пользователей
3. **Убедитесь, что секреты** сохраняются в базе данных

## Рекомендации по использованию

### Для пользователей:
1. **Сохраняйте резервные копии** TOTP секретов
2. **Используйте надежные пароли** в дополнение к TOTP
3. **Регулярно обновляйте** приложения аутентификации

### Для разработчиков:
1. **Используйте отладочные логи** для проверки работы системы
2. **Тестируйте разные сценарии** входа
3. **Следите за безопасностью** хранения секретов